{% extends "layout.html" %}
{% block title %}Editor{% endblock %}
{% block head %}
	{{ super() }}
	<script type="text/javascript" src="{{url_for('static', filename='editor.js')}}"></script>
	<link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
{% endblock %}

{% block options %}
	<br>
	<p class="nav-link" data-toggle="modal" data-target="#generateExamsModal" href="">Generar exámenes</p>
	<a class="nav-link" href="/main">Panel principal</a>
{% endblock %}

{% block content %}
	<br>
	<div class="card bg-light editorCard" style="border-color: #7c8482;">
		<table cellpadding="10">
			<tr>
				<td>
					<h2>Editando: {{ folderName }}</h2>
					<p class="lead">Preguntas: <span id="countQuestions"></span></p>
				</td>
				<td>
					<div style="float:right">
						<button type="button" class="btn btn-danger" data-toggle="modal" data-target="#undoChangesModal">
							<i class="material-icons">settings_backup_restore</i>
						</button>
						<button type="button" class="btn btn-danger" data-toggle="modal" data-target="#deleteFolderModal">
							<i class="material-icons">delete</i>
						</button>
						<button type="button" class="btn btn-primary" onclick="save()">
							<i class="material-icons">save</i>
						</button>
					</div>
				</td>
			</tr>
		</table>
	</div>

	<br>
	<div id="messageError" class="alert alert-danger" style="display:none"></div>
	{{save}}
	<div id="messageSuccess">
		{% if caller == "saveFolder" %}
			<div class="alert alert-success">Se han guardado los cambios</div>
			{% set caller = "F" %}
		{% endif %}
	</div>

	{% set empty = [] %}
	<span id="questionFormat" style="display:none">{{ questionFormat(empty) }}</span>
	<span id="sectionFormat" style="display:none">{{ sectionFormat(empty) }}</span>
	<form id="editor" class="animated fadeIn" action="/saveFolder" method="POST">
		<input type="hidden" name="folderId" value={{ folderId }}>
		
		{% if contents|length > 0 %}
			{% for element in contents %}
				{% if element.section is defined %}
					{{ sectionFormat(element) }}
				{% else %}
					{{ questionFormat(element) }}
				{% endif %}
			{% endfor %}
		{% else %}
			<script>addSection(); addQuestion();</script>
		{% endif %}
	</form>
	<script>countElements();</script>

	<br>
	<center>
		<button type="button" class="btn btn-success" onclick="addQuestion()">
			<i class="material-icons">add</i> Pregunta
		</button>
		<button type="button" class="btn btn-success" onclick="addSection()">
			<i class="material-icons">add</i> Seccion
		</button>
	</center>
	
	<div class="modal fade" id="deleteQuestionModal">
		<div class="modal-dialog">
			<div class="modal-content">
			    <!-- Modal Header -->
				<div class="modal-header">
					<h4 class="modal-title">Eliminar pregunta</h4>
			    	<button type="button" class="close" data-dismiss="modal">&times;</button>
			    </div>
			  	<!-- Modal body -->
			  	<div class="modal-body">
    				<label for="name">¿Desea eliminar la pregunta?</label>
			  	</div>
			  	<!-- Modal footer -->
			  	<div class="modal-footer">
			  		<button type="button" class="btn btn-danger" onclick="confirmDeleteQuestion()" data-dismiss="modal">Eliminar</button>
			    	<button type="button" class="btn btn-primary" data-dismiss="modal">Cancelar</button>
			  	</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="deleteSectionModal">
		<div class="modal-dialog">
			<div class="modal-content">
			    <!-- Modal Header -->
				<div class="modal-header">
					<h4 class="modal-title">Eliminar seccion</h4>
			    	<button type="button" class="close" data-dismiss="modal">&times;</button>
			    </div>
			  	<!-- Modal body -->
			  	<div class="modal-body">
    				<label for="name">¿Desea eliminar la seccion y todas sus preguntas?</label>
			  	</div>
			  	<!-- Modal footer -->
			  	<div class="modal-footer">
			  		<button type="button" class="btn btn-danger" onclick="confirmDeleteSection()" data-dismiss="modal">Eliminar</button>
			    	<button type="button" class="btn btn-primary" data-dismiss="modal">Cancelar</button>
			  	</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="generateExamsModal">
		<div class="modal-dialog">
			<div class="modal-content">
			    <!-- Modal Header -->
				<div class="modal-header">
					<h4 class="modal-title">Crear exámenes</h4>
			    	<button type="button" class="close" data-dismiss="modal">&times;</button>
			    </div>
			    <form action="/generateExams" method="POST" id="generateExamsForm"
			          onkeypress="return event.keyCode != 13;">
				  	<!-- Modal body -->
				  	<div class="modal-body">
						<label>Número de reactivos por examen:</label>
						<input type="number" min="1" class="form-control" name="reactivos">
						<label>Cantidad de exámenes a generar:</label>
						<input type="number" min="1" class="form-control" name="exams">
 						<br>
 						<div id="generateExamsError" class="alert alert-danger" style="display:none"></div>
 						<input type="hidden" name="folderName" value="{{ folderName }}">
				  	</div>
				</form>
			  	<!-- Modal footer -->
			  	<div class="modal-footer">
			  		<button type="button" class="btn btn-primary" onclick="generateExams()">Crear</button>
			    	<button type="button" class="btn btn-danger" data-dismiss="modal">Cancelar</button>
			  	</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="undoChangesModal">
		<div class="modal-dialog">
			<div class="modal-content">
			    <!-- Modal Header -->
				<div class="modal-header">
					<h4 class="modal-title">Descartar cambios</h4>
			    	<button type="button" class="close" data-dismiss="modal">&times;</button>
			    </div>
			  	<!-- Modal body -->
			  	<div class="modal-body">
    				<label for="name">¿Desea regresar al estado del último guardado? No se podrán recuperar los cambios.</label>
			  	</div>
			  	<form id="folderData" action="/openFolder" method="POST" style="display:none">
			  		<input type="hidden" name="folderId" value="{{ folderId }}">
			  	</form>
			  	<!-- Modal footer -->
			  	<div class="modal-footer">
			  		<button type="button" class="btn btn-danger" onclick="confirmUndoChanges()" data-dismiss="modal">Descartar</button>
			    	<button type="button" class="btn btn-primary" data-dismiss="modal">Cancelar</button>
			  	</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="formulaExplainModal">
		<div class="modal-dialog">
			<div class="modal-content">
			    <!-- Modal Header -->
				<div class="modal-header">
					<h4 class="modal-title">Fórmulas algebráicas</h4>
			    	<button type="button" class="close" data-dismiss="modal">&times;</button>
			    </div>
			  	<!-- Modal body -->
			  	<div class="modal-body">
    				Aqui vamos a explicar el formato con el que deben
    				de escribir las formulas para que se generen preguntas
    				dinamicamente
			  	</div>
			  	<!-- Modal footer -->
			  	<div class="modal-footer">
			    	<button type="button" class="btn btn-primary" data-dismiss="modal">Cerrar</button>
			  	</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="deleteFolderModal">
		<div class="modal-dialog">
			<div class="modal-content">
			    <!-- Modal Header -->
				<div class="modal-header">
					<h4 class="modal-title">Crear nueva carpeta</h4>
			    	<button type="button" class="close" data-dismiss="modal">&times;</button>
			    </div> 
			  	<!-- Modal body -->
			  	<div class="modal-body">
		    		<label>Seguro que desea eliminar la forma?</label>
			  	</div>
				<form id="deleteFolderForm" action="/delFolder" method="POST" 
					onkeypress="return event.keyCode != 13;">
					<input type="hidden" name="folderId" value="{{ folderId }}">
				  	<!-- Modal footer -->
				  	<div class="modal-footer">
				  		<input type="submit" class="btn btn-danger" value="Eliminar"></input>
				    	<button type="button" class="btn btn-primary" data-dismiss="modal">Cancelar</button>
				  	</div>
				</form>
			</div>
		</div>
	</div>
{% endblock %}

{% macro questionFormat(question) %}	
	{% set questionIdFromHeader = "this.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement" %}
	{% set optionsFromAlgebra = "this.parentElement.parentElement.parentElement.nextElementSibling.firstChild" %}
	{% set formulaFromAlgebra = "this.parentElement.parentElement.parentElement.nextElementSibling.nextElementSibling.firstChild" %}
	<section class="question">
		<div class="card editorCard" style="border-color: #56b0ff;">
			<table style="width:100%; min-width:500px">
				<tr>
					<td colspan="2">
						<div style="float:left; margin-top:8px">
							<label class="lead">Pregunta <span class="questionNumber"></span>:</label>
						</div>
						<div style="float:right">
							<button type="button" class="btn btn-basic btn-sm" onclick="moveQuestionUp({{ questionIdFromHeader }})">
								<i class="material-icons">arrow_upward</i>
							</button>
							<button type="button" class="btn btn-basic btn-sm" onclick="moveQuestionDown({{ questionIdFromHeader }})">
								<i class="material-icons">arrow_downward</i>
							</button>
							<button type="button" class="btn btn-basic btn-sm" onclick="deleteQuestion({{ questionIdFromHeader }})">
								<i class="material-icons">delete</i>
							</button>
						</div>
					</td>
				</tr>
				<tr>
					<td colspan="2">
						<input type="text" class="form-control" name="question" onchange="Saved=false" value="{{ question.statement }}">
					</td>
				</tr>
				<tr>
					<td>
						<label><input type="checkbox" value="T" name="algebra" onchange="toggleQuestion(this, {{ formulaFromAlgebra }}, {{ optionsFromAlgebra }})" {% if question.algebraic %} checked {% endif %}>¿Algebráico?</label>
					</td>
				</tr>
				<tr><td colspan="2" {% if question.algebraic is defined%} style="display:none" {% endif %}><table style="width:100%">
					<tr>
						<td>
							<label class="form-l">Respuesta Correcta:</label>
						</td>
						<td>
							<input type="text" class="form-control answer" name="1" onchange="Saved=false" value="{{ question.correct }}">
						</td>
					</tr>
					<tr>
						<td style="vertical-align: top">
							<label class="form-l">Distractores:</label>
						</td>
						<td>
							<input style="margin-bottom:2px" type="text" class="form-control answer" name="2" onchange="Saved=false" value="{{ question.distractor1 }}">
							<input style="margin-bottom:2px" type="text" class="form-control answer" name="3" onchange="Saved=false" value="{{ question.distractor2 }}">
							<input style="margin-bottom:2px" type="text" class="form-control answer" name="4" onchange="Saved=false" value="{{ question.distractor3 }}">
						</td>
					</tr>
				</table></td></tr>
				<tr><td colspan="2" {% if question.algebraic is not defined %} style="display:none" {% endif %}><table style="width:100%">
					<tr>
						<td>
							<label class="form-l">Fórmula:</label>
							<a data-toggle="modal" data-target="#formulaExplainModal" href="">?</a>
						</td>
						<td>
							<input type="text" class="form-control formula" name="5" onchange="Saved=false" value="{{ question.formula }}">
						</td>
					</tr>
				</table></td></tr>
			</table>
		</div>
		<br>
	</section>
{% endmacro %}

{% macro sectionFormat(section) %}
	{% set sectionIdFromBtn = "this.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement" %}
	<section class="section">
		<div class="card editorCard" style="border-color: #6de8ce;">
			<table style="width:100%; min-width:500px">
				<tr>
					<td>
						<label class="lead">Seccion <span class="sectionNumber"></span>:</label>
					</td>
					<td>
						<input type="text" class="form-control" name="section" onchange="Saved=false" value="{{ section.section }}">
					</td>
					<td align="right">
						<button type="button" class="btn btn-basic btn-sm" onclick="deleteSection({{ sectionIdFromBtn }})">
							<i class="material-icons">delete</i>
						</button>
					</td>
				</tr>
			</table>
		</div>
		<br>
	</section>
{% endmacro %}