{% extends "layout.html" %}
{% block title %}Editor{% endblock %}
{% block head %}
	{{ super() }}
{% endblock %}

{% block options %}
	<br>
	<p class="nav-link" data-toggle="modal" data-target="#generateExamsModal" href="">Generar exámenes</p>
{% endblock %}

{% block content %}
	<br>
	<div class="card bg-light editorCard">
		<table cellpadding="10">
			<tr>
				<td>
					<h2>Editando: {{ evalName }}</h2>
				</td>
				<td>
					<p class="lead" style="float:right">Preguntas: <span id="countQuestions"></span></p>
				</td>
			</tr>
		</table>
	</div>

	{% set empty = [] %}
	<span id="questionFormat" style="display:none">{{ questionFormat(empty) }}</span>
	<form id="editor" action="/saveEval" method="POST">
		<input type="hidden" name="evalId" value={{ evalId }}>
		{% if questions|length > 0 %}
			{% for question in questions %}
				{{ questionFormat(question) }}
			{% endfor %}
		{% else %}
			<script>addQuestion();</script>
		{% endif %}
	</form>
	<script>countQuestions();</script>

	<br>
	<center><button type="button" class="btn btn-success" onclick="addQuestion()">Agregar pregunta</button></center>

	<br>
	<div id="messageError" class="alert alert-danger" style="display:none"></div>
	{{save}}
	{% if caller == "saveEval" %}
		<div class="alert alert-success">Se han guardado los cambios</div>
		{% set caller = "F" %}
	{% endif %}

	<div id="messageError" class="alert alert-danger" style="display:none"></div>
	<div style="float:right; margin-bottom:50px">
		<button type="button" class="btn btn-danger" data-toggle="modal" data-target="#undoChangesModal">Descartar cambios</button>
		<button type="button" class="btn btn-primary" onclick="save()">Guardar cambios</button>
	</div>
	
	<div class="modal fade" id="deleteQuestionModal">
		<div class="modal-dialog">
			<div class="modal-content">
			    <!-- Modal Header -->
				<div class="modal-header">
					<h4 class="modal-title">Eliminar pregunta</h4>
			    	<button type="button" class="close" data-dismiss="modal">&times;</button>
			    </div>
			  	<!-- Modal body -->
			  	<div class="modal-body">
    				<label for="name">¿Desea eliminar la pregunta?</label>
			  	</div>
			  	<!-- Modal footer -->
			  	<div class="modal-footer">
			  		<button type="button" class="btn btn-danger" onclick="confirmDeleteQuestion()" data-dismiss="modal">Eliminar</button>
			    	<button type="button" class="btn btn-primary" data-dismiss="modal">Cancelar</button>
			  	</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="generateExamsModal">
		<div class="modal-dialog">
			<div class="modal-content">
			    <!-- Modal Header -->
				<div class="modal-header">
					<h4 class="modal-title">Crear exámenes</h4>
			    	<button type="button" class="close" data-dismiss="modal">&times;</button>
			    </div>
			    <form action="/generateExams" method="POST" id="generateExamsForm"
			          onkeypress="return event.keyCode != 13;">
				  	<!-- Modal body -->
				  	<div class="modal-body">
						<label>Número de reactivos por examen:</label>
						<input type="number" min="1" class="form-control" name="reactivos">
						<label>Cantidad de exámenes a generar:</label>
						<input type="number" min="1" class="form-control" name="exams">
 						<br>
 						<div id="generateExamsError" class="alert alert-danger" style="display:none"></div>
 						<input type="hidden" name="evalName" value="{{ evalName }}">
				  	</div>
				</form>
			  	<!-- Modal footer -->
			  	<div class="modal-footer">
			  		<button type="button" class="btn btn-primary" onclick="generateExams()">Crear</button>
			    	<button type="button" class="btn btn-danger" data-dismiss="modal">Cancelar</button>
			  	</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="undoChangesModal">
		<div class="modal-dialog">
			<div class="modal-content">
			    <!-- Modal Header -->
				<div class="modal-header">
					<h4 class="modal-title">Descartar cambios</h4>
			    	<button type="button" class="close" data-dismiss="modal">&times;</button>
			    </div>
			  	<!-- Modal body -->
			  	<div class="modal-body">
    				<label for="name">¿Desea regresar al estado del ultimo guardado? No se podran recuperar los cambios.</label>
			  	</div>
			  	<form id="evalData" action="/openEval" method="POST" style="display:none">
			  		<input type="hidden" name="evalId" value="{{ evalId }}">
			  	</form>
			  	<!-- Modal footer -->
			  	<div class="modal-footer">
			  		<button type="button" class="btn btn-danger" onclick="confirmUndoChanges()" data-dismiss="modal">Descartar</button>
			    	<button type="button" class="btn btn-primary" data-dismiss="modal">Cancelar</button>
			  	</div>
			</div>
		</div>
	</div>
{% endblock %}

{% macro questionFormat(question) %}	
	{% set questionIdFromHeader = "this.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement" %}
	{% set optionsFromAlgebra = "this.parentElement.parentElement.parentElement.nextElementSibling.firstChild" %}
	{% set formulaFromAlgebra = "this.parentElement.parentElement.parentElement.nextElementSibling.nextElementSibling.firstChild" %}
	<section class="question animated fadeIn">
		<br>
		<div class="card editorCard">
			<table style="width:100%; min-width:500px">
				<tr>
					<td colspan="2">
						<div style="float:left; margin-top:8px">
							<label class="lead">Pregunta <span class="count"></span>:</label>
						</div>
						<div style="float:right">
							<button type="button" class="btn btn-basic btn-sm" onclick="moveQuestionUp({{ questionIdFromHeader }})">
								<i class="material-icons">arrow_upward</i>
							</button>
							<button type="button" class="btn btn-basic btn-sm" onclick="moveQuestionDown({{ questionIdFromHeader }})">
								<i class="material-icons">arrow_downward</i>
							</button>
							<button type="button" class="btn btn-basic btn-sm" onclick="deleteQuestion({{ questionIdFromHeader }})">
								<i class="material-icons">delete</i>
							</button>
						</div>
					</td>
				</tr>
				<tr>
					<td colspan="2">
						<input type="text" class="form-control" name="question" onchange="Saved=false" value="{{ question.statement }}">
					</td>
				</tr>
				<tr>
					<td>
						<label><input type="checkbox" value="T" name="algebra" onchange="toggleQuestion(this, {{ formulaFromAlgebra }}, {{ optionsFromAlgebra }})" {% if question.algebraic %} checked {% endif %}>Algebraico?</label>
					</td>
				</tr>
				<tr><td colspan="2" {% if question.algebraic is defined%} style="display:none" {% endif %}><table style="width:100%">
					<tr>
						<td>
							<label class="form-l">Respuesta Correcta:</label>
						</td>
						<td>
							<input type="text" class="form-control answer" name="1" onchange="Saved=false" value="{{ question.correct }}">
						</td>
					</tr>
					<tr>
						<td style="vertical-align: top">
							<label class="form-l">Distractores:</label>
						</td>
						<td>
							<input style="margin-bottom:2px" type="text" class="form-control answer" name="2" onchange="Saved=false" value="{{ question.distractor1 }}">
							<input style="margin-bottom:2px" type="text" class="form-control answer" name="3" onchange="Saved=false" value="{{ question.distractor2 }}">
							<input style="margin-bottom:2px" type="text" class="form-control answer" name="4" onchange="Saved=false" value="{{ question.distractor3 }}">
						</td>
					</tr>
				</table></td></tr>
				<tr><td colspan="2" {% if question.algebraic is not defined %} style="display:none" {% endif %}><table style="width:100%">
					<tr>
						<td>
							<label class="form-l">Formula:</label>
						</td>
						<td>
							<input type="text" class="form-control formula" name="5" onchange="Saved=false" value="{{ question.formula }}">
						</td>
					</tr>
				</table></td></tr>
			</table>
		</div>
	</section>
{% endmacro %}